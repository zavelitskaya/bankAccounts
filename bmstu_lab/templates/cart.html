{% extends "base.html" %}
{% load static %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞{% endblock %}

{% block content %}
<div class="cart-page">
    {% if cart_items %}
    <div class="cart-content">
        <!-- –°–ø–∏—Å–æ–∫ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
        <div class="cart-items-section">
            <h2>–î–æ–≥–æ–≤–æ—Ä—ã –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å—á–µ—Ç—É ({{ cart_items|length }})</h2>
            <div class="cart-items">
                {% for item in cart_items %}
                <div class="cart-item" data-contract-id="{{ item.id }}">
                    <div class="cart-item-main">
                        <div class="cart-item-image">
                            <img src="{{ item.image_url }}" alt="{{ item.service_type }}" class="cart-item-img">
                        </div>
                        <div class="cart-item-details">
                            <h3>{{ item.number }}</h3>
                            <p class="cart-item-client">{{ item.client }}</p>
                            <span class="service-badge">{{ item.service_type }}</span>
                            
                            <!-- –¢–æ–≥–≥–ª –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ -->
                            <div class="main-contract-toggle">
                                <label class="toggle-label">
                                    <input type="checkbox" 
                                           class="main-contract-checkbox" 
                                           data-contract-id="{{ item.id }}"
                                           {% if main_contract_id == item.id %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-text">–û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–≥–æ–≤–æ—Ä –¥–ª—è —Å—á–µ—Ç–∞</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="cart-item-actions">
                        <button class="remove-from-cart-btn" data-contract-id="{{ item.id }}">
                            <img src="{% static 'icons/trash.svg' %}" alt="–£–¥–∞–ª–∏—Ç—å" class="trash-icon">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—á–µ—Ç–µ -->
        <div class="cart-sidebar">
            <div class="summary-card">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—á–µ—Ç–µ</h3>
                <div class="account-info">
                    <div class="account-number-section">
                        <label>–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞:</label>
                        <div class="account-number-display">
                            {{ account_number }}
                        </div>
                        <small>–ù–æ–º–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
                    </div>
                    
                    <div class="main-contract-info">
                        <label>–û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–≥–æ–≤–æ—Ä:</label>
                        <div class="main-contract-display">
                            {% for item in cart_items %}
                                {% if main_contract_id == item.id %}
                                    {{ item.number }} - {{ item.client }}
                                {% endif %}
                            {% empty %}
                                <span class="no-main-contract">–ù–µ –≤—ã–±—Ä–∞–Ω</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="cart-actions">
                    <button class="create-request-btn primary-btn" 
                            {% if not main_contract_id %}disabled{% endif %}>
                        –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                    <a href="{% url 'contracts_list' %}" class="continue-shopping-btn">
                        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
        <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
        <div class="empty-cart">
            <div class="empty-cart-icon">üõí</div>
            <h2>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
            <p>–í—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –¥–æ–≥–æ–≤–æ—Ä—ã –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—á–µ—Ç–∞</p>
            <a href="{% url 'contracts_list' %}" class="primary-btn">
                –ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–æ–≥–æ–≤–æ—Ä–∞–º
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞
function setMainContract(contractId) {
    console.log('Setting main contract:', contractId);
    
    fetch(`/set-main-contract/${contractId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫–∏ —Å –¥—Ä—É–≥–∏—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
            document.querySelectorAll('.main-contract-checkbox').forEach(checkbox => {
                if (checkbox.dataset.contractId != contractId) {
                    checkbox.checked = false;
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞
            updateMainContractDisplay(contractId);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
            document.querySelector('.create-request-btn').disabled = false;
        }
    })
    .catch(error => {
        console.error('Error setting main contract:', error);
    });
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞
function updateMainContractDisplay(contractId) {
    const contractItem = document.querySelector(`[data-contract-id="${contractId}"]`);
    if (contractItem) {
        const contractNumber = contractItem.querySelector('h3').textContent;
        const clientName = contractItem.querySelector('.cart-item-client').textContent;
        
        document.querySelector('.main-contract-display').innerHTML = 
            `${contractNumber} - ${clientName}`;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
function removeFromCart(contractId) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å) ...
}

// –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞
    document.querySelectorAll('.main-contract-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                setMainContract(this.dataset.contractId);
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
        button.addEventListener('click', function() {
            const contractId = this.dataset.contractId;
            removeFromCart(contractId);
        });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
    document.querySelector('.create-request-btn')?.addEventListener('click', function() {
        const mainContractId = '{{ main_contract_id }}';
        if (mainContractId && confirm('–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å—á–µ—Ç–∞?')) {
            alert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! –°—á–µ—Ç –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.');
        }
    });
});
</script>
{% endblock %}